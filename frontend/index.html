<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>TCC Rotas • OpenRouteService + Leaflet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height:100%; margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial }
    #map { position: absolute; top:0; right:0; bottom:0; left:320px; }
    .panel {
      position:absolute; top:0; left:0; bottom:0; width:320px; background:#fff; border-right:1px solid #eee; padding:14px 12px; overflow:auto;
      box-shadow: 0 2px 10px rgba(0,0,0,.05);
    }
    .panel h2 { margin: 0 0 12px; font-size: 18px; }
    .field { margin-bottom:10px }
    label { display:block; font-size:12px; color:#444; margin-bottom:4px }
    input[type="text"], input[type="number"], select {
      width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; outline:none;
    }
    .row { display:flex; gap:8px }
    .row > .col { flex:1 }
    .btn {
      display:inline-block; padding:10px 12px; border-radius:10px; border:0; background:#111; color:#fff; cursor:pointer;
    }
    .btn.secondary { background:#e9ecef; color:#111 }
    .muted { color:#666; font-size:12px }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#f2f2f2; margin-right:6px; font-size:12px }
    .results { margin-top:10px }
    .result-item { font-size:13px; padding:6px 8px; border-radius:6px; cursor:pointer }
    .result-item:hover { background:#f5f5f5 }
    .metrics { margin-top:10px; padding:8px; background:#f8f9fa; border:1px solid #eee; border-radius:10px; font-size:13px }
  </style>
</head>
<body>
  <div class="panel">
    <h2>Gerador de Rotas (ORS)</h2>

    <div class="field">
      <label>Modo de Rota</label>
      <select id="mode">
        <option value="car">Carro (baseline)</option>
        <option value="hgv" selected>Caminhão (driving-hgv)</option>
      </select>
    </div>

    <div class="field">
      <label>Origem</label>
      <div class="row">
        <div class="col"><input id="origin" type="text" placeholder="ex.: Av. Brasil, Foz do Iguaçu"/></div>
        <button class="btn secondary" id="btnGeocodeOrigin" title="Buscar endereço">Buscar</button>
      </div>
      <div id="resultsOrigin" class="results"></div>
      <div class="muted">Dica: clique no mapa para definir origem/destino rapidamente.</div>
    </div>

    <div class="field">
      <label>Destino</label>
      <div class="row">
        <div class="col"><input id="destination" type="text" placeholder="ex.: Ponte da Amizade"/></div>
        <button class="btn secondary" id="btnGeocodeDest" title="Buscar endereço">Buscar</button>
      </div>
      <div id="resultsDest" class="results"></div>
    </div>

    <div class="field">
      <label>Paradas (waypoints) — opcional</label>
      <input id="waypoints" type="text" placeholder="lat,lng; lat,lng (ex.: -25.50,-54.60; -25.49,-54.59)"/>
    </div>

    <div class="field">
      <label>Evitar trechos</label>
      <div>
        <label><input type="checkbox" id="avoidTollways"/> Pedágios</label>
        <label><input type="checkbox" id="avoidFerries"/> Balsas</label>
        <label><input type="checkbox" id="avoidHighways"/> Rodovias</label>
      </div>
    </div>

    <div class="field" id="truckFields">
      <label>Restrição do Caminhão (HGV)</label>
      <div class="row">
        <div class="col"><input id="height" type="number" step="0.01" placeholder="Altura (m)"/></div>
        <div class="col"><input id="width" type="number" step="0.01" placeholder="Largura (m)"/></div>
      </div>
      <div class="row">
        <div class="col"><input id="length" type="number" step="0.1" placeholder="Comprimento (m)"/></div>
        <div class="col"><input id="weight" type="number" step="10" placeholder="Peso total (kg)"/></div>
      </div>
      <div class="row">
        <div class="col"><input id="axleload" type="number" step="10" placeholder="Carga por eixo (kg)"/></div>
      </div>
      <div class="muted">Preencha apenas o que for necessário. Valores vazios não serão enviados.</div>
    </div>

    <div class="field">
      <button class="btn" id="btnRoute">Traçar rota</button>
      <button class="btn secondary" id="btnClear" style="float:right">Limpar</button>
    </div>

    <div class="metrics" id="metrics" style="display:none"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API_BASE = "http://localhost:8000/api";

    // Mapa
    const map = L.map('map').setView([-25.516, -54.585], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let originMarker = null, destMarker = null, routeLayer = null;
    let activeField = "origin"; // qual input preencher ao clicar no mapa

    function setActive(field) { activeField = field; }

    document.getElementById('origin').addEventListener('focus', () => setActive('origin'));
    document.getElementById('destination').addEventListener('focus', () => setActive('destination'));

    map.on('click', (e) => {
      const { lat, lng } = e.latlng;
      if (activeField === 'origin') {
        if (originMarker) map.removeLayer(originMarker);
        originMarker = L.marker([lat, lng], { draggable:true }).addTo(map).bindPopup('Origem').openPopup();
        originMarker.on('dragend', ()=> {});
        document.getElementById('origin').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        setActive('destination');
      } else {
        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker([lat, lng], { draggable:true }).addTo(map).bindPopup('Destino').openPopup();
        destMarker.on('dragend', ()=> {});
        document.getElementById('destination').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        setActive('origin');
      }
    });

    function parseLatLng(text) {
      // aceita "lat,lng"
      const p = text.split(",").map(x=>x.trim());
      if (p.length !== 2) return null;
      const lat = parseFloat(p[0]), lng = parseFloat(p[1]);
      if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
      return { lat, lng };
    }

    async function geocode(q, slot) {
      const r = await fetch(`${API_BASE}/geocode`, {
        method: "POST", headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ q, limit: 5, country: "BR" })
      });
      const data = await r.json();
      const target = document.getElementById(slot === 'origin' ? 'resultsOrigin' : 'resultsDest');
      target.innerHTML = "";
      (data.results || []).forEach((res) => {
        const div = document.createElement('div');
        div.className = "result-item";
        div.textContent = res.label;
        div.onclick = () => {
          const val = `${res.lat.toFixed(6)}, ${res.lng.toFixed(6)}`;
          if (slot === 'origin') {
            document.getElementById('origin').value = val;
            if (originMarker) map.removeLayer(originMarker);
            originMarker = L.marker([res.lat, res.lng]).addTo(map).bindPopup('Origem');
            map.setView([res.lat, res.lng], 14);
          } else {
            document.getElementById('destination').value = val;
            if (destMarker) map.removeLayer(destMarker);
            destMarker = L.marker([res.lat, res.lng]).addTo(map).bindPopup('Destino');
            map.setView([res.lat, res.lng], 14);
          }
          target.innerHTML = "";
        };
        target.appendChild(div);
      });
    }

    document.getElementById('btnGeocodeOrigin').onclick = () => {
      const q = document.getElementById('origin').value.trim();
      if (!q) return alert("Digite algo para buscar a origem");
      geocode(q, 'origin');
    };
    document.getElementById('btnGeocodeDest').onclick = () => {
      const q = document.getElementById('destination').value.trim();
      if (!q) return alert("Digite algo para buscar o destino");
      geocode(q, 'destination');
    };

    function getAvoidFeatures() {
      const a = [];
      if (document.getElementById('avoidTollways').checked) a.push('tollways');
      if (document.getElementById('avoidFerries').checked) a.push('ferries');
      if (document.getElementById('avoidHighways').checked) a.push('highways');
      return a;
    }

    function parseWaypoints() {
      const text = document.getElementById('waypoints').value.trim();
      if (!text) return [];
      return text.split(";").map(s=>s.trim()).map(parseLatLng).filter(Boolean);
    }

    function showMetrics(summary) {
      const el = document.getElementById('metrics');
      if (!summary) {
        el.style.display = 'none'; return;
      }
      const km = (summary.distance_m / 1000).toFixed(2);
      const min = Math.round(summary.duration_s / 60);
      el.innerHTML = `
        <div><span class="pill">Distância</span> ${km} km</div>
        <div><span class="pill">Duração</span> ${min} min</div>
      `;
      el.style.display = 'block';
    }

    async function route() {
      // lê origem e destino (aceita lat,lng)
      const oTxt = document.getElementById('origin').value.trim();
      const dTxt = document.getElementById('destination').value.trim();
      const o = parseLatLng(oTxt);
      const d = parseLatLng(dTxt);
      if (!o || !d) return alert("Use 'lat,lng' ou faça geocoding para origem e destino.");

      const waypoints = parseWaypoints();
      const avoid_features = getAvoidFeatures();

      const mode = document.getElementById('mode').value;
      let url = `${API_BASE}/rota-carro`;
      let body = { origin: o, destination: d, waypoints, avoid_features };

      if (mode === 'hgv') {
        url = `${API_BASE}/rota-caminhao`;
        const truck = {};
        const h = parseFloat(document.getElementById('height').value);
        const w = parseFloat(document.getElementById('width').value);
        const l = parseFloat(document.getElementById('length').value);
        const wt = parseFloat(document.getElementById('weight').value);
        const ax = parseFloat(document.getElementById('axleload').value);
        if (!Number.isNaN(h)) truck.height = h;
        if (!Number.isNaN(w)) truck.width = w;
        if (!Number.isNaN(l)) truck.length = l;
        if (!Number.isNaN(wt)) truck.weight = wt;
        if (!Number.isNaN(ax)) truck.axleload = ax;
        body.truck = truck;
      }

      const r = await fetch(url, {
        method: "POST", headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });
      const data = await r.json();

      if (!r.ok) {
        console.error(data);
        return alert(`Erro ao calcular rota: ${data.error || r.status}`);
      }

      if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
      const geo = data.geojson || data; // compat
      routeLayer = L.geoJSON(geo).addTo(map);

      // ajustar mapa
      try {
        map.fitBounds(routeLayer.getBounds());
      } catch (e) {}

      showMetrics(data.summary || null);
    }

    document.getElementById('btnRoute').onclick = route;

    document.getElementById('btnClear').onclick = () => {
      document.getElementById('origin').value = "";
      document.getElementById('destination').value = "";
      document.getElementById('waypoints').value = "";
      ['height','width','length','weight','axleload'].forEach(id=>document.getElementById(id).value="");
      ['avoidTollways','avoidFerries','avoidHighways'].forEach(id=>document.getElementById(id).checked=false);
      if (originMarker) { map.removeLayer(originMarker); originMarker=null; }
      if (destMarker) { map.removeLayer(destMarker); destMarker=null; }
      if (routeLayer) { map.removeLayer(routeLayer); routeLayer=null; }
      document.getElementById('metrics').style.display='none';
    };

    // Mostra/oculta campos de caminhão conforme modo
    function toggleTruckFields() {
      const on = document.getElementById('mode').value === 'hgv';
      document.getElementById('truckFields').style.display = on ? 'block' : 'none';
    }
    document.getElementById('mode').addEventListener('change', toggleTruckFields);
    toggleTruckFields();
  </script>
</body>
</html>
