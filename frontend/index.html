<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>TCC Rotas • OpenRouteService + Leaflet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --brand: #111827;
      --brand-weak: #e9ecef;
      --pill: #f3f4f6;
      --shadow: 0 8px 30px rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0f15;
        --card: #121821;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --border: #1f2937;
        --brand: #f9fafb;
        --brand-weak: #243447;
        --pill: #1f2937;
        --shadow: 0 8px 30px rgba(0,0,0,.35);
      }
    }
    * { box-sizing: border-box }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial }
    .app {
      display:grid; grid-template-columns: min(380px, 100%) 1fr; height:100%;
    }
    .panel {
      padding:16px; border-right:1px solid var(--border); background:var(--card);
      box-shadow: var(--shadow); z-index:10; overflow:auto;
    }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px }
    .title { font-size:18px; font-weight:700 }
    .badge { font-size:12px; color:var(--muted) }
    .field { margin:10px 0 }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px }
    input[type="text"], input[type="number"], select {
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:transparent; color:var(--text); outline:none;
    }
    .row { display:flex; gap:8px }
    .row > .col { flex:1 }
    .btn {
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:12px; border:1px solid transparent; cursor:pointer; user-select:none;
      background:var(--brand); color:var(--bg); font-weight:600;
    }
    .btn.secondary { background:var(--brand-weak); color:var(--text) }
    .btn.ghost { background:transparent; border-color:var(--border); color:var(--text) }
    .muted { color:var(--muted); font-size:12px }
    .results { margin-top:8px; border:1px solid var(--border); border-radius:12px; overflow:hidden }
    .result-item { font-size:13px; padding:8px 10px; cursor:pointer; border-bottom:1px solid var(--border); background:transparent }
    .result-item:last-child { border-bottom:0 }
    .result-item:hover { background:rgba(127,127,127,.08) }
    .metrics { margin-top:12px; padding:10px; border:1px solid var(--border); border-radius:12px; background:transparent; font-size:13px }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:var(--pill); margin-right:6px; font-size:12px }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
    .switch { display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted) }

    #map { position: relative; height:100%; width:100%; }
    .map-wrap { position:relative }
    .toast {
      position:fixed; right:16px; bottom:16px; background:#ef4444; color:#fff; padding:10px 12px; border-radius:10px;
      box-shadow: var(--shadow); font-size:13px; display:none;
    }
    .loading {
      display:none; font-size:12px; color:var(--muted); margin-left:8px;
    }
    .divider { height:1px; background:var(--border); margin:12px 0 }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <div class="header">
        <div>
          <div class="title">Gerador de Rotas (ORS)</div>
          <div class="badge">Leaflet + Django API</div>
        </div>
        <button class="btn ghost" id="btnClear" title="Limpar tudo">Limpar</button>
      </div>

      <div class="field">
        <label>Modo de Rota</label>
        <div class="row">
          <div class="col">
            <select id="mode">
              <option value="car">Carro (driving-car)</option>
              <option value="hgv" selected>Caminhão (driving-hgv)</option>
            </select>
          </div>
          <button class="btn secondary" id="btnSwap" title="Inverter origem e destino">⟲ Inverter</button>
        </div>
      </div>

      <div class="field">
        <label>Origem</label>
        <div class="row">
          <div class="col"><input id="origin" type="text" placeholder="ex.: Shopping JL Cataratas, Foz do Iguaçu"/></div>
          <button class="btn secondary" id="btnGeocodeOrigin" title="Buscar endereço">Buscar</button>
        </div>
        <div class="toolbar">
          <button class="btn ghost" id="btnUseMyLocation">Usar minha localização</button>
          <span class="loading" id="originLoading">buscando…</span>
        </div>
        <div id="resultsOrigin" class="results" style="display:none"></div>
      </div>

      <div class="field">
        <label>Destino</label>
        <div class="row">
          <div class="col"><input id="destination" type="text" placeholder="ex.: Uniamérica Descomplica, Foz do Iguaçu"/></div>
          <button class="btn secondary" id="btnGeocodeDest" title="Buscar endereço">Buscar</button>
        </div>
        <div id="resultsDest" class="results" style="display:none"></div>
      </div>

      <div class="field">
        <label>Paradas (waypoints) — opcional</label>
        <input id="waypoints" type="text" placeholder="lat,lng; lat,lng (ex.: -25.50,-54.60; -25.49,-54.59)"/>
      </div>

      <div class="divider"></div>

      <div class="field">
        <label>Escopo da busca</label>
        <div class="row">
          <div class="col">
            <select id="country">
              <option value="BR" selected>Brasil</option>
              <option value="">Mundo inteiro</option>
            </select>
          </div>
          <label class="switch"><input type="checkbox" id="useBounds"/> Usar área visível</label>
        </div>
        <div class="muted">Com “Usar área visível”, o geocode restringe aos bounds atuais do mapa.</div>
      </div>

      <div class="field">
        <label>Evitar trechos</label>
        <div class="row">
          <label class="switch"><input type="checkbox" id="avoidTollways"/> Pedágios</label>
          <label class="switch"><input type="checkbox" id="avoidFerries"/> Balsas</label>
          <label class="switch"><input type="checkbox" id="avoidHighways"/> Rodovias</label>
        </div>
      </div>

      <div class="field" id="truckFields">
        <label>Restrição do Caminhão (HGV)</label>
        <div class="row">
          <div class="col"><input id="height" type="number" step="0.01" placeholder="Altura (m)"/></div>
          <div class="col"><input id="width" type="number" step="0.01" placeholder="Largura (m)"/></div>
        </div>
        <div class="row">
          <div class="col"><input id="length" type="number" step="0.1" placeholder="Comprimento (m)"/></div>
          <div class="col"><input id="weight" type="number" step="10" placeholder="Peso total (kg)"/></div>
        </div>
        <div class="row">
          <div class="col"><input id="axleload" type="number" step="10" placeholder="Carga por eixo (kg)"/></div>
        </div>
        <div class="muted">Preencha apenas o necessário. (Peso/eixo em kg — o backend converte para t.)</div>
      </div>

      <div class="field">
        <div class="row">
          <button class="btn" id="btnRoute">Traçar rota</button>
          <span class="loading" id="routeLoading">calculando…</span>
        </div>
      </div>

      <div class="metrics" id="metrics" style="display:none"></div>
    </aside>

    <main class="map-wrap">
      <div id="map"></div>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ===== Config =====
    const API_BASE = `http://${location.hostname}:8000/api`;

    // ===== UI helpers =====
    const $ = (id) => document.getElementById(id);
    const show = (el, on=true) => el.style.display = on ? '' : 'none';
    const toast = (msg) => { const el = $('toast'); el.textContent = msg; show(el, true); setTimeout(()=>show(el,false), 2600); };
    const debounce = (fn, ms=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    // ===== Map =====
    const map = L.map('map', { zoomControl: true }).setView([-23.55, -46.63], 5);
    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let originMarker = null, destMarker = null, routeLayer = null;
    let activeField = "origin";

    function setActive(field) { activeField = field; }
    $('origin').addEventListener('focus', () => setActive('origin'));
    $('destination').addEventListener('focus', () => setActive('destination'));

    function createDraggableMarker(lat, lng, label) {
      const m = L.marker([lat, lng], { draggable:true }).addTo(map).bindPopup(label);
      m.on('dragend', () => {
        const { lat, lng } = m.getLatLng();
        if (label === 'Origem') $('origin').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        if (label === 'Destino') $('destination').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        route(); // retraça ao arrastar
      });
      return m;
    }

    map.on('click', (e) => {
      const { lat, lng } = e.latlng;
      if (activeField === 'origin') {
        if (originMarker) map.removeLayer(originMarker);
        originMarker = createDraggableMarker(lat, lng, 'Origem');
        $('origin').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        setActive('destination');
      } else {
        if (destMarker) map.removeLayer(destMarker);
        destMarker = createDraggableMarker(lat, lng, 'Destino');
        $('destination').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        setActive('origin');
      }
    });

    // ===== Parsing / Geocode =====
    function parseLatLng(text) {
      const p = text.split(",").map(x=>x.trim());
      if (p.length !== 2) return null;
      const lat = parseFloat(p[0]), lng = parseFloat(p[1]);
      if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
      return { lat, lng };
    }

    function getGeocodePayload(q) {
      const payload = { q, limit: 8, lang: "pt", country: $('country').value };
      if ($('useBounds').checked) {
        const b = map.getBounds();
        payload.rect_north = b.getNorth();
        payload.rect_south = b.getSouth();
        payload.rect_east  = b.getEast();
        payload.rect_west  = b.getWest();
      } else {
        const c = map.getCenter();
        payload.focus_lat = c.lat; payload.focus_lng = c.lng;
      }
      return payload;
    }

    async function geocode(q, slot) {
      const payload = getGeocodePayload(q);
      const r = await fetch(`${API_BASE}/geocode`, {
        method: "POST", headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      const target = (slot === 'origin') ? $('resultsOrigin') : $('resultsDest');
      target.innerHTML = "";
      if (!Array.isArray(data.results) || !data.results.length) {
        show(target, false);
        toast("Nenhum endereço encontrado.");
        return;
      }
      data.results.forEach((res) => {
        const div = document.createElement('div');
        div.className = "result-item";
        div.textContent = res.label;
        div.onclick = () => {
          const val = `${res.lat.toFixed(6)}, ${res.lng.toFixed(6)}`;
          if (slot === 'origin') {
            $('origin').value = val;
            if (originMarker) map.removeLayer(originMarker);
            originMarker = createDraggableMarker(res.lat, res.lng, 'Origem');
          } else {
            $('destination').value = val;
            if (destMarker) map.removeLayer(destMarker);
            destMarker = createDraggableMarker(res.lat, res.lng, 'Destino');
          }
          map.setView([res.lat, res.lng], Math.max(map.getZoom(), 14));
          show(target, false);
        };
        target.appendChild(div);
      });
      show(target, true);
    }

    // autocomplete (debounce)
    $('origin').addEventListener('input', debounce((e)=>{
      const q = e.target.value.trim(); if (!q || parseLatLng(q)) { show($('resultsOrigin'), false); return; }
      geocode(q, 'origin');
    }, 350));
    $('destination').addEventListener('input', debounce((e)=>{
      const q = e.target.value.trim(); if (!q || parseLatLng(q)) { show($('resultsDest'), false); return; }
      geocode(q, 'destination');
    }, 350));

    $('btnGeocodeOrigin').onclick = () => {
      const q = $('origin').value.trim(); if (!q) return toast("Digite algo para buscar a origem");
      geocode(q, 'origin');
    };
    $('btnGeocodeDest').onclick = () => {
      const q = $('destination').value.trim(); if (!q) return toast("Digite algo para buscar o destino");
      geocode(q, 'destination');
    };

    async function resolveByGeocode(text) {
      const payload = getGeocodePayload(text);
      const r = await fetch(`${API_BASE}/geocode`, {
        method: "POST", headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      return (data.results && data.results[0]) ? data.results[0] : null;
    }

    async function resolveInputToLatLng(text) {
      const parsed = parseLatLng(text);
      if (parsed) return parsed;
      const res = await resolveByGeocode(text);
      if (!res) return null;
      return { lat: res.lat, lng: res.lng };
    }

    // ===== Avoid / Waypoints =====
    function getAvoidFeatures() {
      const a = [];
      if ($('avoidTollways').checked) a.push('tollways');
      if ($('avoidFerries').checked) a.push('ferries');
      if ($('avoidHighways').checked) a.push('highways');
      return a;
    }
    function parseWaypoints() {
      const text = $('waypoints').value.trim();
      if (!text) return [];
      return text.split(";").map(s=>s.trim()).map(parseLatLng).filter(Boolean);
    }

    function showMetrics(summary) {
      const el = $('metrics');
      if (!summary) { show(el, false); return; }
      const km = (summary.distance_m / 1000).toFixed(2);
      const min = Math.round(summary.duration_s / 60);
      el.innerHTML = `
        <div><span class="pill">Distância</span> ${km} km</div>
        <div><span class="pill">Duração</span> ${min} min</div>
      `;
      show(el, true);
    }

    // ===== Route =====
    async function route() {
      try {
        show($('routeLoading'), true);
        const oTxt = $('origin').value.trim();
        const dTxt = $('destination').value.trim();
        const o = await resolveInputToLatLng(oTxt);
        const d = await resolveInputToLatLng(dTxt);
        if (!o) { toast("Não consegui resolver a ORIGEM."); return; }
        if (!d) { toast("Não consegui resolver o DESTINO."); return; }

        $('origin').value = `${o.lat.toFixed(6)}, ${o.lng.toFixed(6)}`;
        $('destination').value = `${d.lat.toFixed(6)}, ${d.lng.toFixed(6)}`;

        if (!originMarker) originMarker = createDraggableMarker(o.lat, o.lng, 'Origem');
        if (!destMarker)   destMarker   = createDraggableMarker(d.lat, d.lng, 'Destino');

        const waypoints = parseWaypoints();
        const avoid_features = getAvoidFeatures();

        const mode = $('mode').value;
        let url = `${API_BASE}/rota-carro`;
        let body = { origin: o, destination: d, waypoints, avoid_features };

        if (mode === 'hgv') {
          url = `${API_BASE}/rota-caminhao`;
          const truck = {};
          const h = parseFloat($('height').value);
          const w = parseFloat($('width').value);
          const l = parseFloat($('length').value);
          const wt = parseFloat($('weight').value);
          const ax = parseFloat($('axleload').value);
          if (!Number.isNaN(h)) truck.height = h;
          if (!Number.isNaN(w)) truck.width = w;
          if (!Number.isNaN(l)) truck.length = l;
          if (!Number.isNaN(wt)) truck.weight = wt;
          if (!Number.isNaN(ax)) truck.axleload = ax;
          body.truck = truck;
        }

        const r = await fetch(url, { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(body) });
        const data = await r.json();
        if (!r.ok) { console.error(data); toast(data.error || `Erro ${r.status}`); return; }

        if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
        const geo = data.geojson || data;
        routeLayer = L.geoJSON(geo, {
          style: { weight: 6, opacity: 0.9 }
        }).addTo(map);
        try { map.fitBounds(routeLayer.getBounds(), { padding: [20,20] }); } catch(e){}

        showMetrics(data.summary || null);
      } catch (err) {
        console.error(err); toast("Falha ao calcular rota.");
      } finally {
        show($('routeLoading'), false);
      }
    }

    $('btnRoute').onclick = route;

    // ===== Actions =====
    $('btnClear').onclick = () => {
      ['origin','destination','waypoints','height','width','length','weight','axleload']
        .forEach(id => $(id).value = "");
      ['avoidTollways','avoidFerries','avoidHighways','useBounds']
        .forEach(id => $(id).checked = false);
      if (originMarker) { map.removeLayer(originMarker); originMarker=null; }
      if (destMarker)   { map.removeLayer(destMarker);   destMarker=null; }
      if (routeLayer)   { map.removeLayer(routeLayer);   routeLayer=null; }
      show($('metrics'), false);
      show($('resultsOrigin'), false);
      show($('resultsDest'), false);
    };

    $('mode').addEventListener('change', ()=>{
      const on = $('mode').value === 'hgv';
      $('truckFields').style.display = on ? 'block' : 'none';
    });
    // inicial
    $('truckFields').style.display = $('mode').value === 'hgv' ? 'block' : 'none';

    $('btnSwap').onclick = () => {
      const o = $('origin').value, d = $('destination').value;
      $('origin').value = d; $('destination').value = o;
      if (originMarker && destMarker) {
        const a = originMarker.getLatLng(), b = destMarker.getLatLng();
        originMarker.setLatLng(b); destMarker.setLatLng(a);
      }
      route();
    };

    $('btnUseMyLocation').onclick = () => {
      if (!navigator.geolocation) return toast("Geolocalização não suportada.");
      show($('originLoading'), true);
      navigator.geolocation.getCurrentPosition((pos)=>{
        const { latitude: lat, longitude: lng } = pos.coords;
        $('origin').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        if (originMarker) map.removeLayer(originMarker);
        originMarker = createDraggableMarker(lat, lng, 'Origem');
        map.setView([lat, lng], 14);
        show($('originLoading'), false);
      }, (err)=>{
        console.error(err); toast("Não foi possível obter sua localização.");
        show($('originLoading'), false);
      }, { enableHighAccuracy:true, timeout:8000 });
    };
  </script>
</body>
</html>
